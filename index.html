<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mindcare AI</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden; /* This prevents horizontal scrolling */
        }

        .appsheet-blue {
            background-color: #479EE6;
        }

        /* Styling for the custom dropdowns with search */
        .custom-dropdown {
            position: relative;
            width: 100%;
        }

        .dropdown-input-container {
            position: relative;
        }

        .dropdown-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            background-color: #fff;
            color: #4b5563;
            font-size: 1rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .dropdown-input.placeholder {
            color: #9ca3af;
        }

        .dropdown-options {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 10;
            margin-top: 0.25rem;
            padding: 0.5rem;
            background-color: #fff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            max-height: 200px;
            overflow-y: auto;
        }

        .dropdown-option-item {
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition-property: background-color;
            transition-duration: 150ms;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dropdown-option-item:hover {
            background-color: #f3f4f6;
        }

        .dropdown-option-item[data-selected="true"] {
            background-color: #e5e7eb;
            font-weight: 600;
        }

        /* Styling for age input group */
        .age-input-group {
            display: flex;
            align-items: center;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background-color: #fff;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .age-input-group button {
            background-color: #e5e7eb;
            color: #4b5563;
            font-weight: bold;
            padding: 0.75rem 1rem;
            transition-colors: 0.2s;
            flex-shrink: 0;
        }

        .age-input-group button:hover {
            background-color: #d1d5db;
        }

        .age-input-group input {
            text-align: center;
            width: 100%;
            border: none;
            padding: 0.75rem 0.5rem;
            outline: none;
        }

        /* Styling for the custom radio buttons (Yes/No) */
        .custom-radio-group {
            display: flex;
            gap: 0.5rem;
        }

        .custom-radio-button {
            flex-grow: 1;
            padding: 0.75rem;
            text-align: center;
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        .custom-radio-button:hover {
            background-color: #e5e7eb;
        }

        .custom-radio-button.selected {
            background-color: #479EE6;
            color: white;
            border-color: #479EE6;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Hide original radio inputs */
        .custom-radio-group input[type="radio"] {
            display: none;
        }

        /* Back to Home Button */
        .return-home-btn {
            position: absolute;
            top: 1rem;
            left: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background-color: #fff;
            border-radius: 9999px; /* Tailwind's rounded-full */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            color: #4b5563;
            transition-colors: 0.2s;
            font-weight: 500;
            z-index: 20;
        }

        .return-home-btn:hover {
            background-color: #f3f4f6;
        }

        /* Styling for results page highlights */
        .encoded-string-box {
            background-color: #e2e8f0; /* Tailwind slate-200 */
            padding: 1rem;
            border-radius: 0.5rem;
            word-break: break-all;
            font-family: monospace;
            font-size: 1.1rem;
        }

        /* Modal styling */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            position: relative;
            max-height: 90vh; /* Limits height on smaller screens */
            display: flex;
            flex-direction: column;
        }

        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #9ca3af;
        }

        .close-btn:hover {
            color: #4b5563;
        }

        /* New styles for analysis highlights */
        .analysis-positive {
            padding: 0.75rem;
            background-color: #dcfce7; /* Green 100 */
            color: #166534; /* Green 800 */
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }

        .analysis-negative {
            padding: 0.75rem;
            background-color: #fee2e2; /* Red 100 */
            color: #991b1b; /* Red 800 */
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }

        /* Chatbox specific styles */
        .chatbox-container {
            height: 60vh;
            max-height: 80vh;
        }
        .chat-messages {
            height: 100%;
            overflow-y: auto;
        }

        /* Adjustments for less aggressive text wrapping */
        .chat-text {
            word-break: normal; /* Prevents breaking words unnecessarily */
            overflow-wrap: anywhere;
            white-space: pre-wrap; /* Preserves newlines and whitespace */
            max-width: 100%; /* Ensures it respects the parent container width */
        }
        .chat-bubble {
            max-width: 85%; /* Make the chat bubble a bit wider for better wrapping */
        }

        .ai-attribution {
            font-size: 0.65rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        /* Custom message box for API status */
        .api-message {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 16px;
            border-radius: 9999px; /* rounded-full */
            font-size: 0.75rem;
            font-weight: 500;
            color: white;
            background-color: #4b5563; /* Tailwind gray-700 */
            z-index: 60;
            animation: fadeOut 5s forwards;
        }

        @keyframes fadeOut {
            0% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- --- Home Page Container --- -->
    <div id="homePage" class="flex flex-col items-center max-w-2xl w-full">
        <div class="p-12 bg-white rounded-2xl shadow-xl w-full text-center">
            <h1 class="text-4xl md:text-5xl font-bold text-[#479EE6] mb-4">Mindcare AI</h1>
            <p class="text-gray-600 mb-10 text-lg">Welcome to Mindcare AI! A safe place for you! You can either take the test, or talk to our AI companion.</p>

            <!-- Buttons container -->
            <div class="space-y-6 md:space-y-0 md:flex md:space-x-4">
                <button
                    id="openSurveyBtn"
                    class="w-full bg-blue-600 text-white font-semibold py-4 px-6 rounded-xl shadow-lg hover:bg-blue-700 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300"
                >
                     Depression Test
                </button>
                <button
                    id="aiCompanionBtn"
                    class="w-full bg-emerald-500 text-white font-semibold py-4 px-6 rounded-xl shadow-lg hover:bg-emerald-600 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-emerald-300"
                >
                    AI Companion
                </button>
            </div>
        </div>

        <!-- Disclaimer container -->
        <div class="mt-8 p-6 bg-red-50 border-2 border-red-200 rounded-xl shadow-inner w-full text-left text-sm text-red-800">
            <p class="font-bold mb-2">Disclaimer:</p>
            <p>This AI companion offers general emotional support only.
It is not a substitute for professional mental health care.

The beta depression detection test is experimental.
It is for informational purposes and does not provide a medical diagnosis.
If you're feeling distressed or think you may be experiencing depression,
please consult a licensed mental health professional.
Use of this tool is voluntary and at your own discretion.</p>
        </div>
    </div>

    <!-- --- Test Container --- -->
    <div id="surveyContainer" class="w-full max-w-2xl bg-white rounded-xl shadow-lg overflow-hidden hidden relative">
        <button id="returnHomeFromSurvey" class="return-home-btn">
            <!-- Home icon SVG -->
            <svg xmlns="http://www.w3.org/2d000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                <path fill-rule="evenodd" d="M9.293 2.293a1 1 0 011.414 0l7 7A1 1 0 0117 11h-1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-3a1 1 0 00-1-1H9a1 1 0 00-1 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-6H3a1 1 0 01-.707-1.707l7-7z" clip-rule="evenodd" />
            </svg>
            Home
        </button>
        <!-- Header Section -->
        <div class="appsheet-blue text-white p-6 text-center">
            <h1 class="text-3xl font-bold mb-1">Depression Test</h1>
            <p class="text-sm opacity-90">Please answer the questions below BASED ON THE PAST 2 WEEKS to submit the test.</p>
        </div>

        <!-- Test Form -->
        <form id="depressionSurveyForm" class="p-6 space-y-6">
            <!-- Section: Personal Information -->
            <div class="border-b border-gray-200 pb-4">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Personal Information</h2>

                <!-- Age -->
                <div class="mb-4">
                    <label for="Age" class="block text-sm font-medium text-gray-700 mb-1">Age <span class="text-red-500">*</span></label>
                    <div class="age-input-group">
                        <input type="number" id="Age" name="Age" min="1" max="120" placeholder="18"
                            class="focus:ring-blue-500 focus:border-blue-500 text-center" required>
                        <button type="button" id="decrementAgeBtn">− </button>
                        <button type="button" id="incrementAgeBtn">+</button>
                    </div>
                    <p id="ageError" class="text-red-500 text-xs mt-1 hidden">Please enter a valid age between 1 and 120.</p>
                </div>

                <!-- Gender -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Gender</label>
                    <div class="custom-dropdown" data-name="Gender">
                        <div class="dropdown-input-container">
                            <input type="text" readonly class="dropdown-input placeholder" placeholder="Select Gender">
                        </div>
                        <div class="dropdown-options">
                            <div class="dropdown-option-item" data-value="Male">Male</div>
                            <div class="dropdown-option-item" data-value="Female">Female</div>
                            <div class="dropdown-option-item" data-value="Croissant">Croissant</div>
                            <div class="dropdown-option-item" data-value="Others">Others</div>
                        </div>
                        <input type="hidden" name="Gender" required>
                    </div>
                </div>

                <!-- Profession -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Profession</label>
                    <div class="custom-dropdown" data-name="Profession">
                        <div class="dropdown-input-container">
                            <input type="text" readonly class="dropdown-input placeholder" placeholder="Select Profession">
                        </div>
                        <div class="dropdown-options">
                            <div class="dropdown-option-item" data-value="Student">Student</div>
                            <div class="dropdown-option-item" data-value="Employee">Employee</div>
                            <div class="dropdown-option-item" data-value="Others">Others</div>
                        </div>
                        <input type="hidden" name="Profession" required>
                    </div>
                </div>

                <!-- Marital Status -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Marital Status</label>
                    <div class="custom-dropdown" data-name="MaritalStatus">
                        <div class="dropdown-input-container">
                            <input type="text" readonly class="dropdown-input placeholder" placeholder="Select Marital Status">
                        </div>
                        <div class="dropdown-options">
                            <div class="dropdown-option-item" data-value="Single">Single</div>
                            <div class="dropdown-option-item" data-value="Married">Married</div>
                            <div class="dropdown-option-item" data-value="Divorced">Divorced</div>
                        </div>
                        <input type="hidden" name="MaritalStatus" required>
                    </div>
                </div>
            </div>

            <!-- Section: Well-being Questions (Yes/No) -->
            <div class="border-b border-gray-200 pb-4">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Well-being & Daily Life</h2>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Are you satisfied with your life? <span class="text-red-500">*</span></label>
                    <div class="custom-radio-group" data-name="SatisfiedLife">
                        <div class="custom-radio-button" data-value="No">No</div>
                        <div class="custom-radio-button" data-value="Yes">Yes</div>
                        <input type="hidden" name="SatisfiedLife" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Have you dropped activities you used to enjoy? <span class="text-red-500">*</span></label>
                    <div class="custom-radio-group" data-name="DroppedActivities">
                        <div class="custom-radio-button" data-value="No">No</div>
                        <div class="custom-radio-button" data-value="Yes">Yes</div>
                        <input type="hidden" name="DroppedActivities" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Do you feel your life is empty? <span class="text-red-500">*</span></label>
                    <div class="custom-radio-group" data-name="FeelLifeEmpty">
                        <div class="custom-radio-button" data-value="No">No</div>
                        <div class="custom-radio-button" data-value="Yes">Yes</div>
                        <input type="hidden" name="FeelLifeEmpty" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Do you often feel bored? <span class="text-red-500">*</span></label>
                    <div class="custom-radio-group" data-name="Bored">
                        <div class="custom-radio-button" data-value="No">No</div>
                        <div class="custom-radio-button" data-value="Yes">Yes</div>
                        <input type="hidden" name="Bored" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Do you feel helpless? <span class="text-red-500">*</span></label>
                    <div class="custom-radio-group" data-name="FeelHelpless">
                        <div class="custom-radio-button" data-value="No">No</div>
                        <div class="custom-radio-button" data-value="Yes">Yes</div>
                        <input type="hidden" name="FeelHelpless" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Are you afraid that something bad will happen to you? <span class="text-red-500">*</span></label>
                    <div class="custom-radio-group" data-name="AfraidBadHappening">
                        <div class="custom-radio-button" data-value="No">No</div>
                        <div class="custom-radio-button" data-value="Yes">Yes</div>
                        <input type="hidden" name="AfraidBadHappening" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Are you hopeful about the future? <span class="text-red-500">*</span></label>
                    <div class="custom-radio-group" data-name="HopefulAboutFuture">
                        <div class="custom-radio-button" data-value="No">No</div>
                        <div class="custom-radio-button" data-value="Yes">Yes</div>
                        <input type="hidden" name="HopefulAboutFuture" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Do you spend time happily? <span class="text-red-500">*</span></label>
                    <div class="custom-radio-group" data-name="SpendTimeHappily">
                        <div class="custom-radio-button" data-value="No">No</div>
                        <div class="custom-radio-button" data-value="Yes">Yes</div>
                        <input type="hidden" name="SpendTimeHappily" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Do you feel full of energy? <span class="text-red-500">*</span></label>
                    <div class="custom-radio-group" data-name="FeelEnergy">
                        <div class="custom-radio-button" data-value="No">No</div>
                        <div class="custom-radio-button" data-value="Yes">Yes</div>
                        <input type="hidden" name="FeelEnergy" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Do you prefer to stay home rather than going out and doing new things? <span class="text-red-500">*</span></label>
                    <div class="custom-radio-group" data-name="PreferStayHome">
                        <div class="custom-radio-button" data-value="No">No</div>
                        <div class="custom-radio-button" data-value="Yes">Yes</div>
                        <input type="hidden" name="PreferStayHome" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Do you have problems with memory loss? <span class="text-red-500">*</span></label>
                    <div class="custom-radio-group" data-name="MemoryLoss">
                        <div class="custom-radio-button" data-value="No">No</div>
                        <div class="custom-radio-button" data-value="Yes">Yes</div>
                        <input type="hidden" name="MemoryLoss" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Do you consider yourself worthless? <span class="text-red-500">*</span></label>
                    <div class="custom-radio-group" data-name="ConsiderWorthless">
                        <div class="custom-radio-button" data-value="No">No</div>
                        <div class="custom-radio-button" data-value="Yes">Yes</div>
                        <input type="hidden" name="ConsiderWorthless" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Do you cry most of the time? <span class="text-red-500">*</span></label>
                    <div class="custom-radio-group" data-name="CryMostOfTheTime">
                        <div class="custom-radio-button" data-value="No">No</div>
                        <div class="custom-radio-button" data-value="Yes">Yes</div>
                        <input type="hidden" name="CryMostOfTheTime" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Are you feeling reduced appetite and losing weight? <span class="text-red-500">*</span></label>
                    <div class="custom-radio-group" data-name="FeelingReduceAppetiteAndLosingWeight">
                        <div class="custom-radio-button" data-value="No">No</div>
                        <div class="custom-radio-button" data-value="Yes">Yes</div>
                        <input type="hidden" name="FeelingReduceAppetiteAndLosingWeight" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Do you feel your situation is hopeless? <span class="text-red-500">*</span></label>
                    <div class="custom-radio-group" data-name="SituationHopeless">
                        <div class="custom-radio-button" data-value="No">No</div>
                        <div class="custom-radio-button" data-value="Yes">Yes</div>
                        <input type="hidden" name="SituationHopeless" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Do you feel others are better than you? <span class="text-red-500">*</span></label>
                    <div class="custom-radio-group" data-name="PeopleBetterThanYou">
                        <div class="custom-radio-button" data-value="No">No</div>
                        <div class="custom-radio-button" data-value="Yes">Yes</div>
                        <input type="hidden" name="PeopleBetterThanYou" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Do you feel others would be better off if you died? <span class="text-red-500">*</span></label>
                    <div class="custom-radio-group" data-name="OthersWouldBetterYouDied">
                        <div class="custom-radio-button" data-value="No">No</div>
                        <div class="custom-radio-button" data-value="Yes">Yes</div>
                        <input type="hidden" name="OthersWouldBetterYouDied" required>
                    </div>
                </div>
            </div>

            <!-- Section: Graded Questions -->
            <div class="pb-4">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Social & Emotional Well-being</h2>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Are you avoiding social gatherings? <span class="text-red-500">*</span></label>
                    <div class="custom-radio-group" data-name="AvoidingSocialGatherings">
                        <div class="custom-radio-button" data-value="Most of the times">Most of the times</div>
                        <div class="custom-radio-button" data-value="Sometimes">Sometimes</div>
                        <div class="custom-radio-button" data-value="Not at all">Not at all</div>
                        <input type="hidden" name="AvoidingSocialGatherings" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Do you sleep well? <span class="text-red-500">*</span></label>
                    <div class="custom-radio-group" data-name="SleepWell">
                        <div class="custom-radio-button" data-value="Most of the times">Most of the times</div>
                        <div class="custom-radio-button" data-value="Sometimes">Sometimes</div>
                        <div class="custom-radio-button" data-value="Not at all">Not at all</div>
                        <input type="hidden" name="SleepWell" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Do you feel bad and guilty? <span class="text-red-500">*</span></label>
                    <div class="custom-radio-group" data-name="FeelBadAndGuilty">
                        <div class="custom-radio-button" data-value="Most of the times">Most of the times</div>
                        <div class="custom-radio-button" data-value="Sometimes">Sometimes</div>
                        <div class="custom-radio-button" data-value="Not at all">Not at all</div>
                        <input type="hidden" name="FeelBadAndGuilty" required>
                    </div>
                </div>
            </div>

            <!-- Submit Button & Decode Button -->
            <div class="flex flex-col md:flex-row gap-4">
                <button type="submit"
                    class="appsheet-blue text-white py-3 px-6 rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 w-full text-lg font-semibold transition-colors duration-200">
                    Submit Survey
                </button>
                 <button
                    type="button"
                    id="openDecoderFromSurveyBtn"
                    class="w-full bg-gray-400 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-gray-500 transition duration-300 ease-in-out focus:outline-none focus:ring-4 focus:ring-gray-300"
                >
                    Decode a Code
                </button>
            </div>
        </form>
    </div>

    <!-- --- Decoder Results Container --- -->
    <div id="decoderResultsContainer" class="w-full max-w-2xl bg-white rounded-xl shadow-lg overflow-hidden hidden relative">
        <button id="returnHomeFromDecoderResults" class="return-home-btn">
            <!-- Home icon SVG -->
            <svg xmlns="http://www.w3.org/2d000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                <path fill-rule="evenodd" d="M9.293 2.293a1 1 0 011.414 0l7 7A1 1 0 0117 11h-1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-3a1 1 0 00-1-1H9a1 1 0 00-1 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-6H3a1 1 0 01-.707-1.707l7-7z" clip-rule="evenodd" />
            </svg>
            Home
        </button>
        <div class="appsheet-blue text-white p-6 text-center">
            <h1 class="text-3xl font-bold mb-1">Diagnosis and Analysis</h1>
            <p class="text-sm opacity-90">Based on your test results, here is a risk analysis.</p>
        </div>
        <div class="p-6 space-y-6">
            <div id="diagnosisCard" class="p-4 bg-blue-50 rounded-xl">
                <h class="font-semibold">Risk Score: <span id="riskScoreValue"></span></h>
                <h2 class="text-xl font-bold text-blue-800 mb-2">Diagnosis: <span id="diagnosisText"></span></h2>
                <div class="flex items-center gap-2 text-blue-700">
                    <script>
                      let riskScoreValue = 30;
                      if (riskScoreValue > 25) {
                        var div = document.getElementById('riskScoreValue');
                        div.innerHTML = '999999';
                      }
                    </script>
                </div>
            </div>

            <div class="p-4 bg-gray-50 rounded-xl">
                <h2 class="text-lg font-semibold text-gray-800 mb-2">Analysis</h2>
                <div id="analysisText" class="text-gray-600 space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- --- Decoder Modal --- -->
    <div id="decoderModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn" id="closeDecoderModal">&times;</span>
            <h2 class="text-xl font-bold mb-4 text-center text-gray-800">Decode Encoded String</h2>
            <p class="text-sm text-gray-600 mb-4 text-center">Paste the encoded string below to see the decoded results.</p>
            <textarea id="decoderInput" class="w-full h-24 p-2 border border-gray-300 rounded-md mb-4 resize-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 025221010100111000111111323"></textarea>
            <p id="decoderError" class="text-red-500 text-sm mb-4 hidden">Error: Invalid code format. Please check the string and try again.</p>
            <button id="decodeBtn" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 ease-in-out focus:outline-none focus:ring-4 focus:ring-blue-300">
                Decode String
            </button>
        </div>
    </div>
    
    <!-- --- AI Companion Modal --- -->
    <div id="aiCompanionModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn" id="closeAICompanionModal">&times;</span>
            <div class="appsheet-blue text-white p-6 text-center rounded-t-xl -mt-8 -mx-8 -mb-4">
                <h1 class="text-3xl font-bold mb-1">AI Companion</h1>
                <p id="api-status" class="text-sm opacity-90">Online. Ready to listen.</p>
            </div>

            <!-- Chatbox area -->
            <div id="chatbox" class="flex-grow p-4 space-y-4 overflow-y-auto chatbox-container mt-4">
                 <!-- Initial greeting message is hardcoded here -->
                 <div class="flex items-start space-x-3 mb-4 justify-start">
                    <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full shadow-lg bg-emerald-500">
                        <svg xmlns="http://www.w3.org/2d000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white lucide lucide-bot"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M7 15h10"/></svg>
                    </div>
                    <div class="flex flex-col items-start chat-bubble">
                        <div class="p-3 rounded-lg max-w-[75%] sm:max-w-[65%] shadow-sm text-sm chat-text bg-gray-200 text-gray-900 rounded-bl-none">
Hello there! I'm here to listen and provide support. How are you feeling today?
                        </div>
                        <p class="ai-attribution">Powered by Gemini</p>
                    </div>
                </div>
            </div>

            <!-- Input area -->
            <div class="p-4 border-t border-gray-200 bg-gray-50 flex items-center space-x-2 rounded-b-xl -mx-8 -mb-8 mt-auto">
                <input type="text" id="chatInput" placeholder="Type your message..." class="flex-grow p-3 rounded-full border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
                <button id="sendBtn" class="p-3 rounded-full bg-blue-500 text-white hover:bg-blue-600 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2d000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send"><path d="m22 2-7 19-9-6-11-2z"/><path d="M22 2L11 13"/></svg>
                </button>
            </div>
            <!-- Temporary message box for API status -->
            <div id="api-message-box" class="hidden api-message"></div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const homePage = document.getElementById('homePage');
            const surveyContainer = document.getElementById('surveyContainer');
            const decoderResultsContainer = document.getElementById('decoderResultsContainer');
            
            const aiCompanionModal = document.getElementById('aiCompanionModal'); 

            const openSurveyBtn = document.getElementById('openSurveyBtn');
            const aiCompanionBtn = document.getElementById('aiCompanionBtn');

            const returnHomeFromSurveyBtn = document.getElementById('returnHomeFromSurvey');
            const returnHomeFromDecoderResultsBtn = document.getElementById('returnHomeFromDecoderResults');
            
            const closeAICompanionModalBtn = document.getElementById('closeAICompanionModal');

            const surveyForm = document.getElementById('depressionSurveyForm');
            const decoderModal = document.getElementById('decoderModal');
            const closeDecoderModalBtn = document.getElementById('closeDecoderModal');
            const decodeBtn = document.getElementById('decodeBtn');
            const decoderInput = document.getElementById('decoderInput');
            const decoderError = document.getElementById('decoderError');
            const diagnosisText = document.getElementById('diagnosisText');
            const riskScoreValue = document.getElementById('riskScoreValue');
            const analysisText = document.getElementById('analysisText');
            const diagnosisCard = document.getElementById('diagnosisCard');
            const ageInput = document.getElementById('Age');
            const decrementAgeBtn = document.getElementById('decrementAgeBtn');
            const incrementAgeBtn = document.getElementById('incrementAgeBtn');
            const ageError = document.getElementById('ageError');
            
            // AI Companion DOM elements
            const chatbox = document.getElementById('chatbox');
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            const apiStatusElement = document.getElementById('api-status');
            const apiMessageBox = document.getElementById('api-message-box');

            // --- AI API Chat History ---
            const GEMINI_MODEL = 'gemini-2.5-flash-preview-05-20';
            const DEEPSEEK_MODEL = 'deepseek-chat';
            const defaultInstruction = `You're a kind and respectful AI assistant who acts like a caring therapist. Focus on offering emotional support and thoughtful responses. Keep answers short and supportive. Don’t give medical advice. If the user asks about something unrelated to feelings or mental well-being, answer briefly and gently steer the conversation back to how they’re feeling or how you can help emotionally. You're a prototype companion. Include international helplines if neccesary`;
            let isLoading = false;
            let chatHistory = [];
            
            // --- Encoding/Decoding Mappings ---
            const encodingMap = {
                Gender: {
                    Male: '1', Female: '2', Croissant: '3', Others: '4'
                },
                Profession: {
                    Student: '1', Employee: '2', Others: '3'
                },
                MaritalStatus: {
                    Single: '1', Married: '2', Divorced: '3'
                },
                'Yes/No': {
                    Yes: '1', No: '0'
                },
                'Graded': {
                    'Not at all': '1', Sometimes: '2', 'Most of the times': '3'
                }
            };

            // Reverse maps for decoding
            const reverseEncodingMap = {
                Gender: {
                    '1': 'Male', '2': 'Female', '3': 'Croissant', '4': 'Others'
                },
                Profession: {
                    '1': 'Student', '2': 'Employee', '3': 'Others'
                },
                MaritalStatus: {
                    '1': 'Single', '2': 'Married', '3': 'Divorced'
                },
                'Yes/No': {
                    '1': 'Yes', '0': 'No'
                },
                'Graded': {
                    '1': 'Not at all', '2': 'Sometimes', '3': 'Most of the times'
                }
            };

            // --- Question order for consistent encoding/decoding ---
            const questionOrder = [
                { name: 'Age', type: 'age', size: 3 },
                { name: 'Gender', type: 'Gender', size: 1 },
                { name: 'Profession', type: 'Profession', size: 1 },
                { name: 'MaritalStatus', type: 'MaritalStatus', size: 1 },
                { name: 'SatisfiedLife', type: 'Yes/No', size: 1 },
                { name: 'DroppedActivities', type: 'Yes/No', size: 1 },
                { name: 'FeelLifeEmpty', type: 'Yes/No', size: 1 },
                { name: 'Bored', type: 'Yes/No', size: 1 },
                { name: 'FeelHelpless', type: 'Yes/No', size: 1 },
                { name: 'AfraidBadHappening', type: 'Yes/No', size: 1 },
                { name: 'HopefulAboutFuture', type: 'Yes/No', size: 1 },
                { name: 'SpendTimeHappily', type: 'Yes/No', size: 1 },
                { name: 'FeelEnergy', type: 'Yes/No', size: 1 },
                { name: 'PreferStayHome', type: 'Yes/No', size: 1 },
                { name: 'MemoryLoss', type: 'Yes/No', size: 1 },
                { name: 'ConsiderWorthless', type: 'Yes/No', size: 1 },
                { name: 'CryMostOfTheTime', type: 'Yes/No', size: 1 },
                { name: 'FeelingReduceAppetiteAndLosingWeight', type: 'Yes/No', size: 1 },
                { name: 'SituationHopeless', type: 'Yes/No', size: 1 },
                { name: 'PeopleBetterThanYou', type: 'Yes/No', size: 1 },
                { name: 'OthersWouldBetterYouDied', type: 'Yes/No', size: 1 },
                { name: 'AvoidingSocialGatherings', type: 'Graded', size: 1 },
                { name: 'SleepWell', type: 'Graded', size: 1 },
                { name: 'FeelBadAndGuilty', type: 'Graded', size: 1 }
            ];

            // --- Scoring system for Risk Score calculation ---
            const scoringMap = {
                'SatisfiedLife': { Yes: 0, No: 2 },
                'DroppedActivities': { Yes: 3, No: 0 },
                'FeelLifeEmpty': { Yes: 5, No: 0 },
                'Bored': { Yes: 3, No: 0 },
                'FeelHelpless': { Yes: 5, No: 0 },
                'AfraidBadHappening': { Yes: 3, No: 0 },
                'HopefulAboutFuture': { Yes: 0, No: 3 },
                'SpendTimeHappily': { Yes: 0, No: 3 },
                'FeelEnergy': { Yes: 0, No: 3 },
                'PreferStayHome': { Yes: 3, No: 0 },
                'MemoryLoss': { Yes: 3, No: 0 },
                'ConsiderWorthless': { Yes: 8, No: 0 },
                'CryMostOfTheTime': { Yes: 5, No: 0 },
                'FeelingReduceAppetiteAndLosingWeight': { Yes: 5, No: 0 },
                'SituationHopeless': { Yes: 8, No: 0 },
                'PeopleBetterThanYou': { Yes: 6, No: 0 },
                'OthersWouldBetterYouDied': { Yes: 14, No: 0 },
                'AvoidingSocialGatherings': { 'Not at all': 0, Sometimes: 3, 'Most of the times': 6 },
                'SleepWell': { 'Not at all': 6, Sometimes: 3, 'Most of the times': 0 },
                'FeelBadAndGuilty': { 'Not at all': 0, Sometimes: 3, 'Most of the times': 6 },
            };

            // --- Advice mappings for detailed analysis ---
            const adviceMap = {
                'Gender': {
                    'Croissant': 'Thank you for sharing your unique identity! Your courage to be yourself is a wonderful and positive trait.'
                },
                'SatisfiedLife': {
                    'Yes': 'It\'s wonderful that you feel satisfied with your life! This is a strong indicator of well-being.',
                    'No': 'Feeling unsatisfied with life can be difficult. It\'s important to explore what\'s causing this and seek ways to improve your situation.'
                },
                'DroppedActivities': {
                    'No': 'It\'s great that you are continuing to engage in activities you enjoy! Maintaining hobbies is a key part of mental health.',
                    'Yes': 'Dropping activities you once enjoyed is a common sign of distress. Consider trying to re-engage with a small activity you once loved.'
                },
                'FeelLifeEmpty': {
                    'No': 'It\'s positive that you don\'t feel your life is empty! This suggests you find meaning and purpose.',
                    'Yes': 'Feeling your life is empty can be a sign of a lack of purpose or fulfillment. Exploring new passions or connecting with others can help.'
                },
                'Bored': {
                    'No': 'It\'s great that you\'re not often bored! Staying engaged and active can boost your mood.',
                    'Yes': 'Frequent boredom can be a symptom of a larger issue. Finding new activities or challenges can help combat these feelings.'
                },
                'FeelHelpless': {
                    'No': 'It\'s a good sign that you don\'t feel helpless. Believing you have control over your life is empowering.',
                    'Yes': 'Feeling helpless can be a heavy burden. Remember that small actions can lead to big changes, and you are not alone in your struggles.'
                },
                'AfraidBadHappening': {
                    'No': 'It\'s positive that you don\'t feel a constant sense of dread. This indicates a sense of safety and security in your daily life.',
                    'Yes': 'Feeling afraid of bad things happening can be a symptom of anxiety. Focus on what you can control and practice mindfulness to stay in the present.'
                },
                'HopefulAboutFuture': {
                    'Yes': 'Being hopeful about the future is a wonderful sign of resilience and optimism. Nurture this feeling!',
                    'No': 'A lack of hope can be a sign of depression. It\'s important to find small, positive things to look forward to and celebrate small wins.'
                },
                'SpendTimeHappily': {
                    'Yes': 'Spending time happily is crucial for well-being. Keep prioritizing activities that bring you joy.',
                    'No': 'If you\'re not spending time happily, it\'s a sign that you might be struggling. Prioritizing self-care and seeking out things that bring you a sense of joy is important.'
                },
                'FeelEnergy': {
                    'Yes': 'Feeling energetic is a great asset! Make sure to maintain healthy habits that support your energy levels.',
                    'No': 'Low energy can be a sign of physical or mental exhaustion. Ensure you are getting enough rest and proper nutrition.'
                },
                'PreferStayHome': {
                    'No': 'It\'s great that you\'re open to going out and doing new things! This can help broaden your horizons and keep your mind active.',
                    'Yes': 'Preferring to stay home and avoiding new things can be a sign of social withdrawal. Try setting a small, achievable goal to go out, like a short walk or a coffee with a friend.'
                },
                'MemoryLoss': {
                    'No': 'It\'s a good sign that you don\'t have problems with memory loss. Mental clarity is important for daily function.',
                    'Yes': 'Problems with memory loss can be a sign of stress, anxiety, or other medical issues. It\'s best to consult with a doctor.'
                },
                'ConsiderWorthless': {
                    'No': 'It\'s crucial that you don\'t feel worthless. Recognizing your value is fundamental to self-esteem and happiness.',
                    'Yes': 'Feeling worthless is a key symptom of depression. It\'s important to remind yourself of your strengths and accomplishments, and to seek support to help change this mindset.'
                },
                'CryMostOfTheTime': {
                    'No': 'It\'s normal to cry sometimes, but not crying most of the time is a positive sign of emotional stability.',
                    'Yes': 'Crying most of the time can be a significant sign of distress or depression. It is important to find a safe space to express these emotions and seek support.'
                },
                'FeelingReduceAppetiteAndLosingWeight': {
                    'No': 'Maintaining a healthy appetite and weight is a good indicator of physical and mental well-being.',
                    'Yes': 'A reduced appetite and weight loss can be a sign of emotional or physical distress. It\'s important to monitor this and seek professional advice if it continues.'
                },
                'SituationHopeless': {
                    'No': 'It\'s a strong positive sign that you don\'t feel your situation is hopeless. Maintaining a sense of hope is vital.',
                    'Yes': 'Feeling hopeless is a serious symptom of depression. Please reach out to a professional or a trusted friend/family member. There is always hope for a better future.'
                },
                'PeopleBetterThanYou': {
                    'No': 'It\'s healthy to not feel that others are better than you. Everyone has unique strengths and weaknesses.',
                    'Yes': 'Feeling that others are better than you can be a sign of low self-esteem. Remember to focus on your own journey and celebrate your progress.'
                },
                'OthersWouldBetterYouDied': {
                    'No': 'It\'s very important that you don\'t feel this way. Your life has value and you have a positive impact on those around you.',
                    'Yes': 'This is a very serious symptom. Please seek immediate help from a mental health professional or a crisis hotline. You are important, and your life matters.'
                },
                'AvoidingSocialGatherings': {
                    'Not at all': 'It\'s great that you\'re not avoiding social gatherings! Social connection is vital for mental health.',
                    'Sometimes': 'Avoiding social gatherings sometimes is normal, but pay attention if it becomes a pattern. Make sure you are maintaining some social connections.',
                    'Most of the times': 'Consistently avoiding social gatherings is a major sign of withdrawal. Actively seeking out social interaction, even if it feels difficult, can be helpful.'
                },
                'SleepWell': {
                    'Most of the times': 'Getting good sleep is a cornerstone of mental and physical health. Keep up your healthy sleep habits!',
                    'Sometimes': 'Having trouble sleeping sometimes is common. Try establishing a consistent bedtime routine to improve your sleep quality.',
                    'Not at all': 'Not sleeping well is a significant stressor. It\'s important to address this, as it can worsen other mental health symptoms. Consider talking to a doctor about sleep hygiene or potential underlying issues.'
                },
                'FeelBadAndGuilty': {
                    'Not at all': 'It\'s a positive sign that you don\'t often feel bad or guilty. It\'s healthy to not dwell on past mistakes.',
                    'Sometimes': 'Feeling bad or guilty sometimes is a normal part of life. The key is to not let these feelings consume you.',
                    'Most of the times': 'Chronic feelings of guilt and worthlessness are major indicators of depression. Seeking professional help to process these emotions is highly recommended.'
                },
            };

            // --- UI/Page Toggling Functions ---
            const showPage = (pageId) => {
                const pages = [homePage, surveyContainer, decoderResultsContainer];
                pages.forEach(page => page.classList.add('hidden'));
                document.getElementById(pageId).classList.remove('hidden');
            };
            
            const showModal = (modalId) => {
                document.getElementById(modalId).classList.remove('hidden');
            };

            const hideModal = (modalId) => {
                document.getElementById(modalId).classList.add('hidden');
            };

            const showApiMessage = (message, type = 'info') => {
                apiMessageBox.textContent = message;
                apiMessageBox.className = `api-message`;
                if (type === 'success') {
                    apiMessageBox.classList.add('bg-green-500');
                } else if (type === 'error') {
                    apiMessageBox.classList.add('bg-red-500');
                } else {
                    apiMessageBox.classList.add('bg-gray-700');
                }
                apiMessageBox.classList.remove('hidden');
            };


            // Event listeners for page navigation
            openSurveyBtn.addEventListener('click', () => showPage('surveyContainer'));
            aiCompanionBtn.addEventListener('click', () => {
                 showModal('aiCompanionModal');
            });
            openDecoderFromSurveyBtn.addEventListener('click', () => showModal('decoderModal'));
            returnHomeFromSurveyBtn.addEventListener('click', () => showPage('homePage'));
            returnHomeFromDecoderResultsBtn.addEventListener('click', () => showPage('homePage'));

            closeDecoderModalBtn.addEventListener('click', () => hideModal('decoderModal'));
            closeAICompanionModalBtn.addEventListener('click', () => hideModal('aiCompanionModal'));

            // --- Age Input Logic ---
            decrementAgeBtn.addEventListener('click', () => {
                let currentAge = parseInt(ageInput.value) || 0;
                if (currentAge > 1) {
                    ageInput.value = currentAge - 1;
                }
            });

            incrementAgeBtn.addEventListener('click', () => {
                let currentAge = parseInt(ageInput.value) || 0;
                if (currentAge < 120) {
                    ageInput.value = currentAge + 1;
                }
            });

            ageInput.addEventListener('input', () => {
                let age = parseInt(ageInput.value);
                if (age < 1 || age > 120) {
                     ageError.classList.remove('hidden');
                } else {
                    ageError.classList.add('hidden');
                }
            });

            // --- Custom Dropdown Logic ---
            document.querySelectorAll('.custom-dropdown').forEach(dropdown => {
                const input = dropdown.querySelector('.dropdown-input');
                const optionsContainer = dropdown.querySelector('.dropdown-options');
                const hiddenInput = dropdown.querySelector('input[type="hidden"]');
                const options = Array.from(optionsContainer.querySelectorAll('.dropdown-option-item'));

                input.addEventListener('focus', () => {
                    optionsContainer.style.display = 'block';
                });

                options.forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const value = option.dataset.value;
                        const text = option.textContent;

                        input.value = text;
                        input.classList.remove('placeholder');
                        hiddenInput.value = value;
                        optionsContainer.style.display = 'none';
                    });
                });

                document.addEventListener('click', (e) => {
                    if (!dropdown.contains(e.target)) {
                        optionsContainer.style.display = 'none';
                    }
                });
            });

            // --- Custom Radio Button Logic (Yes/No and Graded) ---
            document.querySelectorAll('.custom-radio-group').forEach(group => {
                const buttons = group.querySelectorAll('.custom-radio-button');
                const hiddenInput = group.querySelector('input[type="hidden"]');

                buttons.forEach(button => {
                    button.addEventListener('click', () => {
                        buttons.forEach(b => b.classList.remove('selected'));
                        button.classList.add('selected');
                        hiddenInput.value = button.dataset.value;
                    });
                });
            });

            // --- Form Submission Logic (Encodes and decodes to show results) ---
            surveyForm.addEventListener('submit', (e) => {
                e.preventDefault();

                let age = parseInt(ageInput.value);
                if (age < 1 || age > 120) {
                     ageError.classList.remove('hidden');
                     ageInput.focus();
                     return;
                } else {
                     ageError.classList.add('hidden');
                }

                const formData = new FormData(surveyForm);
                let decodedData = {};
                let isValid = true;

                const requiredFields = Array.from(surveyForm.querySelectorAll('[required]'));
                for (const field of requiredFields) {
                    if (!field.value) {
                        const parentGroup = field.closest('.custom-radio-group') || field.closest('.custom-dropdown') || field.closest('.age-input-group');
                        if (parentGroup) {
                            parentGroup.style.border = '1px solid red';
                        }
                        isValid = false;
                        return;
                    }
                }

                document.querySelectorAll('.custom-radio-group, .custom-dropdown, .age-input-group').forEach(el => {
                    el.style.border = '';
                });

                if (isValid) {
                    // Populate decodedData from form inputs
                    for (const question of questionOrder) {
                        const answer = formData.get(question.name);
                        decodedData[question.name] = question.type === 'age' ? parseInt(answer, 10) : answer;
                    }
                    processAndDisplayResults(decodedData);
                }
            });

            // --- Decoding Logic ---
            decodeBtn.addEventListener('click', () => {
                const encodedString = decoderInput.value.trim();
                let decodedData = {};
                let currentIndex = 0;
                let isValid = true;

                // Validate the length of the string
                const expectedLength = questionOrder.reduce((sum, q) => sum + q.size, 0);
                if (encodedString.length !== expectedLength) {
                    decoderError.textContent = `Error: Invalid code length. Expected ${expectedLength} characters, but got ${encodedString.length}.`;
                    decoderError.classList.remove('hidden');
                    return;
                } else {
                    decoderError.classList.add('hidden');
                }

                for (const question of questionOrder) {
                    const substring = encodedString.substring(currentIndex, currentIndex + question.size);
                    let decodedValue;

                    if (question.type === 'age') {
                        decodedValue = parseInt(substring, 10);
                        if (isNaN(decodedValue)) {
                           isValid = false;
                           break;
                        }
                    } else if (reverseEncodingMap[question.type] && reverseEncodingMap[question.type][substring]) {
                        decodedValue = reverseEncodingMap[question.type][substring];
                    } else {
                        isValid = false;
                        break;
                    }

                    decodedData[question.name] = decodedValue;
                    currentIndex += question.size;
                }

                if (isValid) {
                    hideModal('decoderModal');
                    processAndDisplayResults(decodedData);
                } else {
                    decoderError.textContent = "Error: Invalid code format. Please check the string and try again.";
                    decoderError.classList.remove('hidden');
                }
            });

            // --- Risk Score and Analysis Functions ---
            const calculateRiskScore = (data) => {
                let score = 0;
                for (const key in data) {
                    if (scoringMap[key]) {
                        const answer = data[key];
                        if (scoringMap[key][answer] !== undefined) {
                            score += scoringMap[key][answer];
                        }
                    }
                }
                return score;
            };

            const getDiagnosis = (score) => {
                if (score <= 8) {
                    return { diagnosis: 'Low Risk', cardColor: 'bg-green-50' };
                } else if (score > 8 && score <= 15) {
                    return { diagnosis: 'Medium Risk', cardColor: 'bg-yellow-50' };
                } else {
                    return { diagnosis: 'High Risk ', Suggestion: 'We reccomend seeking professional help, call +852 9685 0241', cardColor: 'bg-red-50' };
                }
            };
 
            const generateAnalysis = (data) => {
                const analysisLines = [];
                const positiveResponses = [];
                const negativeResponses = [];

                // Re-map question names to be more readable
                const readableNames = {
                    'SatisfiedLife': 'Are you satisfied with your life?',
                    'DroppedActivities': 'Have you dropped activities you used to enjoy?',
                    'FeelLifeEmpty': 'Do you feel your life is empty?',
                    'Bored': 'Do you often feel bored?',
                    'FeelHelpless': 'Do you feel helpless?',
                    'AfraidBadHappening': 'Are you afraid that something bad will happen to you?',
                    'HopefulAboutFuture': 'Are you hopeful about the future?',
                    'SpendTimeHappily': 'Do you spend time happily?',
                    'FeelEnergy': 'Do you feel full of energy?',
                    'PreferStayHome': 'Do you prefer to stay home rather than going out and doing new things?',
                    'MemoryLoss': 'Do you have problems with memory loss?',
                    'ConsiderWorthless': 'Do you consider yourself worthless?',
                    'CryMostOfTheTime': 'Do you cry most of the time?',
                    'FeelingReduceAppetiteAndLosingWeight': 'Are you feeling reduced appetite and losing weight?',
                    'SituationHopeless': 'Do you feel your situation is hopeless?',
                    'PeopleBetterThanYou': 'Do you feel others are better than you?',
                    'OthersWouldBetterYouDied': 'Do you feel others would be better off if you died?',
                    'AvoidingSocialGatherings': 'Are you avoiding social gatherings?',
                    'SleepWell': 'Do you sleep well?',
                    'FeelBadAndGuilty': 'Do you feel bad and guilty?',
                    'Gender': 'Gender',
                    'Profession': 'Profession',
                    'MaritalStatus': 'Marital Status'
                };

                // Demographic questions to be excluded, except for 'Croissant' gender
                const demographicExclusions = ['Profession', 'MaritalStatus'];

                // Get gender for special case
                const gender = data['Gender'];

                for (const key in data) {
                    // Skip demographic questions unless it's the special gender case
                    if (demographicExclusions.includes(key)) {
                        continue;
                    }
                    if (key === 'Gender' && gender !== 'Croissant') {
                        continue;
                    }

                    const answer = data[key];
                    let score;
                    if (scoringMap[key]) {
                        score = scoringMap[key][answer];
                    } else if (key === 'Gender') {
                        score = 0; // Special case for Croissant, always a positive analysis
                    } else {
                        score = 0;
                    }

                    const questionName = readableNames[key] || key;

                    if (adviceMap[key] && adviceMap[key][answer]) {
                        const advice = adviceMap[key][answer];
                        const line = `<p class="analysis-${score <= 0 ? 'positive' : 'negative'}">${questionName} (${answer}): ${advice}</p>`;
                        if (score <= 0) {
                            positiveResponses.push(line);
                        } else {
                            negativeResponses.push(line);
                        }
                    }
                }

                const combinedResponses = [...positiveResponses.sort((a, b) => a.localeCompare(b)), ...negativeResponses.sort((a, b) => a.localeCompare(b))];
                return combinedResponses.join('');
            };

            const processAndDisplayResults = (data) => {
                // Clear previous analysis
                analysisText.innerHTML = '';

                const riskScore = calculateRiskScore(data);
                const { diagnosis, cardColor } = getDiagnosis(riskScore);
                const analysisHtml = generateAnalysis(data);

                // Update diagnosis card
                diagnosisText.textContent = diagnosis;
                riskScoreValue.textContent = riskScore;
                diagnosisCard.className = `p-4 rounded-xl ${cardColor}`;

                // Update analysis
                analysisText.innerHTML = analysisHtml;

                showPage('decoderResultsContainer');
                // Hide the modal if it's open
                hideModal('decoderModal');
            };

            // --- AI Companion Chatbox Logic ---
            const appendMessage = (sender, text, attribution = 'Gemini') => {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('flex', 'items-start', 'space-x-3', 'mb-4');
                messageDiv.classList.add(sender === 'user' ? 'justify-end' : 'justify-start');

                const iconDiv = document.createElement('div');
                iconDiv.classList.add('flex-shrink-0', 'w-8', 'h-8', 'flex', 'items-center', 'justify-center', 'rounded-full', 'shadow-lg');
                iconDiv.classList.add(sender === 'user' ? 'bg-blue-500' : 'bg-emerald-500');

                iconDiv.innerHTML = sender === 'user' ? `<svg xmlns="http://www.w3.org/2d000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>` : `<svg xmlns="http://www.w3.org/2d000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white lucide lucide-bot"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M7 15h10"/></svg>`;

                const contentDiv = document.createElement('div');
                contentDiv.classList.add('flex', 'flex-col', 'chat-bubble');
                if (sender === 'user') {
                    contentDiv.classList.add('items-end');
                } else {
                    contentDiv.classList.add('items-start');
                }

                const textDiv = document.createElement('div');
                textDiv.classList.add('p-3', 'rounded-lg', 'max-w-full', 'shadow-sm', 'text-sm', 'chat-text');
                if (sender === 'user') {
                    textDiv.classList.add('bg-blue-500', 'text-white', 'rounded-br-none');
                } else {
                    textDiv.classList.add('bg-gray-200', 'text-gray-900', 'rounded-bl-none');
                }
                textDiv.textContent = text; // Use textContent to prevent XSS
                contentDiv.appendChild(textDiv);

                if (sender !== 'user') {
                    const sourceP = document.createElement('p');
                    sourceP.classList.add('ai-attribution');
                    sourceP.textContent = `Powered by ${attribution}`;
                    contentDiv.appendChild(sourceP);
                }

                messageDiv.appendChild(iconDiv);
                messageDiv.appendChild(contentDiv);

                chatbox.appendChild(messageDiv);
                chatbox.scrollTop = chatbox.scrollHeight;
            };

            const showLoadingIndicator = () => {
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'loadingIndicator';
                loadingDiv.classList.add('flex', 'justify-start', 'mb-4');
                loadingDiv.innerHTML = `
                    <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full bg-emerald-500 text-white shadow-lg">
                        <svg xmlns="http://www.w3.org/2d000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white lucide lucide-bot"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M7 15h10"/></svg>
                    </div>
                    <div class="p-3 rounded-lg bg-gray-200 rounded-bl-none ml-3 text-sm flex items-center space-x-2">
                        <svg class="animate-spin h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2d000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Thinking...</span>
                    </div>
                `;
                chatbox.appendChild(loadingDiv);
                chatbox.scrollTop = chatbox.scrollHeight;
            };

            const hideLoadingIndicator = () => {
                const loadingDiv = document.getElementById('loadingIndicator');
                if (loadingDiv) {
                    loadingDiv.remove();
                }
            };
            
            const fetchWithBackoff = async (url, options, retries = 1, delay = 1000) => {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && retries > 0) { // Too Many Requests
                        console.warn(`API call failed with status 429. Retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return fetchWithBackoff(url, options, retries - 1, delay * 2);
                    }
                    if (!response.ok) {
                        throw new Error(`API returned status ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (retries > 0) {
                        console.error(`Fetch attempt failed: ${error.message}. Retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return fetchWithBackoff(url, options, retries - 1, delay * 2);
                    }
                    throw error;
                }
            };

            const sendMessage = async () => {
                const input = chatInput.value.trim();
                if (!input || isLoading) return;

                isLoading = true;
                chatInput.value = '';
                chatInput.disabled = true;
                sendBtn.disabled = true;

                chatHistory.push({ role: 'user', parts: [{ text: input }] });
                appendMessage('user', input);
                showLoadingIndicator();
                
                let responseText = "I'm sorry, I'm unable to connect with the AI services right now. Please try again later.";
                let attribution = 'Offline';

                try {
                    // --- PRIMARY: Attempt to use Gemini API ---
                    const geminiApiKey = ""; // Canvas will provide this automatically
                    const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${geminiApiKey}`;
                    const geminiPayload = {
                        contents: chatHistory,
                        generationConfig: {
                            systemInstruction: {
                                parts: [{ text: defaultInstruction }]
                            }
                        }
                    };

                    const geminiResponse = await fetchWithBackoff(geminiApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(geminiPayload)
                    });

                    const geminiResult = await geminiResponse.json();
                    const geminiText = geminiResult?.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (geminiText) {
                        responseText = geminiText;
                        attribution = 'Gemini';
                        showApiMessage('Using Gemini API', 'success');
                    } else {
                        // Throw an error if Gemini response is malformed, so the catch block handles the fallback
                        throw new Error('Gemini API response was empty or malformed.');
                    }
                } catch (geminiError) {
                    console.error('Gemini API call failed, attempting fallback to DeepSeek:', geminiError);
                    showApiMessage('Gemini API failed, swiching to another...', 'error');

                    // --- FALLBACK: Attempt to use DeepSeek API or a simulated response ---
                    try {
                        const deepseekApiKey = "sk-517b3eac91cb4f49908d226cee8dbddd"; // IMPORTANT: You can add your DeepSeek API key here if you have one.
                        if (deepseekApiKey) {
                            const deepseekApiUrl = "https://api.deepseek.com/v1/chat/completions";
                            
                            const deepseekMessages = chatHistory.map(msg => ({
                                role: msg.role === 'model' ? 'assistant' : msg.role,
                                content: msg.parts.map(part => part.text).join('')
                            }));

                            const deepseekPayload = {
                                model: DEEPSEEK_MODEL,
                                messages: deepseekMessages,
                                max_tokens: 1024,
                                temperature: 0.7
                            };

                            const deepseekResponse = await fetchWithBackoff(deepseekApiUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${deepseekApiKey}`
                                },
                                body: JSON.stringify(deepseekPayload)
                            });
                            
                            const deepseekResult = await deepseekResponse.json();
                            const deepseekText = deepseekResult?.choices?.[0]?.message?.content;

                            if (deepseekText) {
                                responseText = deepseekText;
                                attribution = 'DeepSeek';
                                showApiMessage('Using DeepSeek API (fallback)', 'success');
                            } else {
                                throw new Error('DeepSeek API response was empty or malformed.');
                            }
                        } else {
                            // SIMULATED RESPONSE if no DeepSeek API key is provided
                            console.warn('DeepSeek API key is missing. Providing a simulated response.');
                            showApiMessage('Simulating DeepSeek API (fallback)', 'success');
                            responseText = 'I apologize, but I am unable to connect with my primary companion services at this time. As a fallback, I can offer some general support. Please know that your feelings are valid, and taking the time to share them is a positive step. How can I support you right now?';
                            attribution = 'Simulated DeepSeek';
                        }
                    } catch (deepseekError) {
                        // Final fallback if DeepSeek also fails
                        console.error('DeepSeek API fallback also failed:', deepseekError);
                        showApiMessage('Both APIs failed. Try again later.', 'error');
                        responseText = 'I apologize, but I am unable to connect with my companion services at this time. Please try again later or reach out to a professional for support.';
                        attribution = 'Offline';
                    }
                } finally {
                    hideLoadingIndicator();
                    chatHistory.push({ role: 'model', parts: [{ text: responseText }] });
                    appendMessage('ai', responseText, attribution);
                    isLoading = false;
                    chatInput.disabled = false;
                    sendBtn.disabled = false;
                    chatInput.focus();
                }
            };

            sendBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });
    </script>
</body>
</html>
